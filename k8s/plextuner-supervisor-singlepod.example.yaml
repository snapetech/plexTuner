apiVersion: v1
kind: ConfigMap
metadata:
  name: plextuner-supervisor-config
  namespace: plex
data:
  supervisor.json: |
    REPLACE_WITH_k8s/plextuner-supervisor-multi.example.json
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: plextuner-supervisor
  namespace: plex
  labels:
    app: plextuner-supervisor
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: plextuner-supervisor
  template:
    metadata:
      labels:
        app: plextuner-supervisor
    spec:
      # Pin to the node where the image is present. Change to match your environment.
      nodeSelector:
        kubernetes.io/hostname: kspld0
      tolerations:
        # Tolerate k3s agent flaps on the pinned node (unreachable/not-ready taints).
        - key: node.kubernetes.io/unreachable
          operator: Exists
          effect: NoSchedule
        - key: node.kubernetes.io/unreachable
          operator: Exists
          effect: NoExecute
        - key: node.kubernetes.io/not-ready
          operator: Exists
          effect: NoSchedule
        - key: node.kubernetes.io/not-ready
          operator: Exists
          effect: NoExecute
      # Required for HDHR LAN broadcast discovery (UDP/TCP 65001) in most k8s setups.
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      containers:
        - name: plextuner
          image: plex-tuner:latest
          imagePullPolicy: IfNotPresent
          args: ["supervise", "-config", "/config/supervisor.json"]
          env:
            # Common inherited envs for all child instances (per-child JSON envs override these).
            - name: TZ
              value: America/Chicago
            # Abort HLS streams immediately when a segment is CF-blocked (redirected to
            # cloudflare-terms-of-service-abuse.com) instead of stalling 12s then dropping.
            - name: PLEX_TUNER_FETCH_CF_REJECT
              value: "true"
            # PLEX_HOST and PLEX_TOKEN are inherited by child instances that need to perform
            # Plex API registration (those with -mode=full -register-plex=api in their args).
            # Note: PLEX_TUNER_PMS_URL and PLEX_TUNER_PMS_TOKEN are explicitly filtered by
            # the supervisor's shouldDropChildInheritedEnv; use PLEX_HOST/PLEX_TOKEN instead.
            - name: PLEX_HOST
              value: "192.168.50.85:32400"
            - name: PLEX_TOKEN
              valueFrom:
                secretKeyRef:
                  name: plex-token
                  key: token
            - name: PLEX_TUNER_PMS_URL
              value: http://plex.plex.svc:32400
            - name: PLEX_TUNER_PMS_TOKEN
              valueFrom:
                secretKeyRef:
                  name: plex-token
                  key: token
            - name: PLEX_TUNER_PLEX_SESSION_REAPER
              value: "true"
            - name: PLEX_TUNER_PLEX_SESSION_REAPER_POLL_S
              value: "2"
            - name: PLEX_TUNER_PLEX_SESSION_REAPER_IDLE_S
              value: "15"
            - name: PLEX_TUNER_PLEX_SESSION_REAPER_RENEW_LEASE_S
              value: "20"
            - name: PLEX_TUNER_PLEX_SESSION_REAPER_HARD_LEASE_S
              value: "1800"
            - name: PLEX_TUNER_PLEX_SESSION_REAPER_SSE
              value: "true"
          ports:
            - { name: hdhr-http, containerPort: 5004, protocol: TCP }
            - { name: cat-5101, containerPort: 5101, protocol: TCP }
            - { name: cat-5102, containerPort: 5102, protocol: TCP }
            - { name: cat-5103, containerPort: 5103, protocol: TCP }
            - { name: cat-5104, containerPort: 5104, protocol: TCP }
            - { name: cat-5105, containerPort: 5105, protocol: TCP }
            - { name: cat-5106, containerPort: 5106, protocol: TCP }
            - { name: cat-5107, containerPort: 5107, protocol: TCP }
            - { name: cat-5108, containerPort: 5108, protocol: TCP }
            - { name: cat-5109, containerPort: 5109, protocol: TCP }
            - { name: cat-5110, containerPort: 5110, protocol: TCP }
            - { name: cat-5111, containerPort: 5111, protocol: TCP }
            - { name: cat-5112, containerPort: 5112, protocol: TCP }
            - { name: cat-5113, containerPort: 5113, protocol: TCP }
            - { name: hdhr-disc, containerPort: 65001, protocol: UDP }
            - { name: hdhr-ctrl, containerPort: 65001, protocol: TCP }
          volumeMounts:
            - name: supervisor-config
              mountPath: /config
            - name: data
              mountPath: /data
          livenessProbe:
            httpGet:
              path: /discover.json
              port: 5004
            # 600s initial delay: hdhr-main must finish initial catalog fetch before liveness fires.
            # With 28 children and 503-heavy upstream, first startup can take 5-15 minutes.
            initialDelaySeconds: 600
            periodSeconds: 30
            failureThreshold: 10
          readinessProbe:
            httpGet:
              path: /discover.json
              port: 5004
            initialDelaySeconds: 120
            periodSeconds: 10
            failureThreshold: 60
          resources:
            requests:
              cpu: 250m
              memory: 512Mi
            limits:
              cpu: "4"
              # 28 child instances performing concurrent HTTP category fetches need headroom.
              # OOM at 1-2Gi; 8Gi comfortably handles all children during initial catalog build.
              memory: 8Gi
      volumes:
        - name: supervisor-config
          configMap:
            name: plextuner-supervisor-config
        - name: data
          # hostPath so catalogs survive pod restarts (avoids full re-fetch on every restart).
          # Change path to match your node's data directory.
          hostPath:
            path: /mnt/datapool_lvm_media/plextuner-supervisor-data
            type: DirectoryOrCreate
---
apiVersion: v1
kind: Service
metadata:
  name: plextuner-hdhr
  namespace: plex
spec:
  selector:
    app: plextuner-supervisor
  ports:
    - { name: http, port: 5004, targetPort: 5004, protocol: TCP }
---
apiVersion: v1
kind: Service
metadata:
  name: plextuner-bcastus
  namespace: plex
spec:
  selector:
    app: plextuner-supervisor
  ports:
    - { name: http, port: 5004, targetPort: 5101, protocol: TCP }
---
apiVersion: v1
kind: Service
metadata:
  name: plextuner-newsus
  namespace: plex
spec:
  selector:
    app: plextuner-supervisor
  ports:
    - { name: http, port: 5004, targetPort: 5102, protocol: TCP }
---
apiVersion: v1
kind: Service
metadata:
  name: plextuner-sportsa
  namespace: plex
spec:
  selector:
    app: plextuner-supervisor
  ports:
    - { name: http, port: 5004, targetPort: 5103, protocol: TCP }
---
apiVersion: v1
kind: Service
metadata:
  name: plextuner-sportsb
  namespace: plex
spec:
  selector:
    app: plextuner-supervisor
  ports:
    - { name: http, port: 5004, targetPort: 5104, protocol: TCP }
---
apiVersion: v1
kind: Service
metadata:
  name: plextuner-moviesprem
  namespace: plex
spec:
  selector:
    app: plextuner-supervisor
  ports:
    - { name: http, port: 5004, targetPort: 5105, protocol: TCP }
---
apiVersion: v1
kind: Service
metadata:
  name: plextuner-generalent
  namespace: plex
spec:
  selector:
    app: plextuner-supervisor
  ports:
    - { name: http, port: 5004, targetPort: 5106, protocol: TCP }
---
apiVersion: v1
kind: Service
metadata:
  name: plextuner-docsfam
  namespace: plex
spec:
  selector:
    app: plextuner-supervisor
  ports:
    - { name: http, port: 5004, targetPort: 5107, protocol: TCP }
---
apiVersion: v1
kind: Service
metadata:
  name: plextuner-ukie
  namespace: plex
spec:
  selector:
    app: plextuner-supervisor
  ports:
    - { name: http, port: 5004, targetPort: 5108, protocol: TCP }
---
apiVersion: v1
kind: Service
metadata:
  name: plextuner-eunordics
  namespace: plex
spec:
  selector:
    app: plextuner-supervisor
  ports:
    - { name: http, port: 5004, targetPort: 5109, protocol: TCP }
---
apiVersion: v1
kind: Service
metadata:
  name: plextuner-eusouth
  namespace: plex
spec:
  selector:
    app: plextuner-supervisor
  ports:
    - { name: http, port: 5004, targetPort: 5110, protocol: TCP }
---
apiVersion: v1
kind: Service
metadata:
  name: plextuner-eueast
  namespace: plex
spec:
  selector:
    app: plextuner-supervisor
  ports:
    - { name: http, port: 5004, targetPort: 5111, protocol: TCP }
---
apiVersion: v1
kind: Service
metadata:
  name: plextuner-latin
  namespace: plex
spec:
  selector:
    app: plextuner-supervisor
  ports:
    - { name: http, port: 5004, targetPort: 5112, protocol: TCP }
---
apiVersion: v1
kind: Service
metadata:
  name: plextuner-otherworld
  namespace: plex
spec:
  selector:
    app: plextuner-supervisor
  ports:
    - { name: http, port: 5004, targetPort: 5113, protocol: TCP }
---
apiVersion: v1
kind: Service
metadata:
  name: plextuner-hdhr-test2
  namespace: plex
spec:
  selector:
    app: plextuner-supervisor
  ports:
    - { name: http, port: 5004, targetPort: 5006, protocol: TCP }
